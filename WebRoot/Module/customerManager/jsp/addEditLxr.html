<!DOCTYPE html>
<html>
<head>
 	<meta charset="utf-8"/>
 	<link href="/plugins/layui/css/layui.css" rel="stylesheet" type="text/css"/>
 	<link href="/plugins/pace/pace-theme-flash.min.css" rel="stylesheet" type="text/css"/>
 	<link href="/Module/customerManager/css/customerManager.css" rel="stylesheet" type="text/css"/>
	<script src="/plugins/pace/pace.min.js" type="text/javascript"></script>
  	<title>增加编辑联系人</title>
</head>
<body style="background:#fff;">
	<div id="lxrWrap" class="layui-form">
		<div class="layui-form-item" style="margin-top:15px;">
			<label class="layui-form-label">联系人姓名</label>
			<div class="layui-input-block">
				<input type="text" name="lxrName" required lay-verify="judgeName" placeholder="请输入联系人姓名(4字以内)" maxlength="4" autocomplete="off" class="layui-input"/>
			</div>				
		</div>
		<div class="layui-form-item" style="margin-top:15px;">
			<label class="layui-form-label">联系人电话</label>
			<div class="layui-input-block">
				<input type="text" name="lxrTel" required lay-verify="judgePhoneNum" placeholder="请输入联系人手机号码" maxlength="11" autocomplete="off" class="layui-input"/>
			</div>				
		</div>
		<div class="layui-form-item" style="margin-top:15px;">
			<label class="layui-form-label">联系人邮箱</label>
			<div class="layui-input-block">
				<input type="text" name="lxrEmail" required lay-verify="email" placeholder="请输入联系人邮箱" autocomplete="off" class="layui-input"/>
			</div>				
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"></label>
			<div class="layui-input-block">
				<button type="button" lay-submit lay-filter="setLxrInfo" class="layui-btn" style="width:120px;margin-left:50px;">保存信息</button>
			</div>
		</div>
	</div>
	
	<script src="/plugins/layui/layui.js"></script>
	<script type="text/javascript">
		//addLxrOpts editLxrOpts
		var addEditLxrOpts = parent.addEditLxrOpts,cusId = parent.globalCusId,lxrId = parent.globalLxrId;
		layui.use(['layer','jquery','form'],function(){
			var layer = layui.layer,
				$ = layui.jquery,
				form = layui.form;
			var page = {
				init : function(){
					this.onLoad();
				},
				onLoad : function(){
					if(addEditLxrOpts == 'editLxrOpts'){//表示编辑
						var _this = this;
						layer.load('1');
						$.ajax({
		   					type:'post',
		   			        async:false,
		   			        dataType:'json',
		   			        data:{lxrId : lxrId,opt:'lxr'},
		   			        url:'/customer.do?action=getCusDetail',
		   			        success:function (json){
		   			        	layer.closeAll('loading');
		   			        	if(json['result'] == 'success'){
		   			        		_this.renderEditLxr(json);
		   			        	}else if(json['result'] == 'error'){
		   			        		layer.msg('系统错误，请稍后重试', {icon:5,anim:6,time:1000});
		   			        	}else if(json['result'] == 'noInfo'){
		   			        		layer.msg('暂无此联系人信息', {icon:5,anim:6,time:1000});
		   			        	}
		   			        }
		   				});
					}
				},
				//编辑时渲染结构
				renderEditLxr : function(json){
					var strHtml = '';
					//联系人姓名
					strHtml += '<div class="layui-form-item" style="margin-top:15px;"><label class="layui-form-label">联系人姓名</label><div class="layui-input-block">';
					strHtml += '<input type="text" name="lxrName" required lay-verify="judgeName" value="'+ json.lxrName +'" placeholder="请输入联系人姓名(4字以内)" maxlength="4" autocomplete="off" class="layui-input"/></div></div>';
					//联系人电话
					strHtml += '<div class="layui-form-item" style="margin-top:15px;"><label class="layui-form-label">联系人电话</label><div class="layui-input-block">';
					strHtml += '<input type="text" name="lxrTel" required lay-verify="judgePhoneNum" value="'+ json.lxrTel +'" placeholder="请输入联系人手机号码" maxlength="11" autocomplete="off" class="layui-input"/></div></div>';
					//联系人邮箱
					strHtml += '<div class="layui-form-item" style="margin-top:15px;"><label class="layui-form-label">联系人邮箱</label><div class="layui-input-block">';
					strHtml += '<input type="text" name="lxrEmail" required lay-verify="email" value="'+ json.lxrEmail +'" placeholder="请输入联系人邮箱" autocomplete="off" class="layui-input"/></div></div>';
					strHtml += '<div class="layui-form-item" style="margin-top:15px;"><label class="layui-form-label"></label><div class="layui-input-block">';
					strHtml += '<button type="button" lay-submit lay-filter="setLxrInfo" class="layui-btn" style="width:120px;margin-left:50px;">保存信息</button></div></div>';
					
					$('#lxrWrap').html(strHtml);
				}
			};
			//自定义表单验证
  			form.verify({
  				judgeName : function(value){
  					var reg = /^[\u4E00-\u9FA5]+$/; 
					if(value == ''){
						return '联系人姓名不能为空';
					}else if(!reg.test(value)){
				      return '联系人姓名应为汉字';
				    }else if(value.length < 2 || value.length > 4){
				    	 return '联系人户姓名最少应为2个字符最多为4个字符';
				    }
  				},
  				judgePhoneNum : function(value){
					var v= value.replace(/ /g,"");
					if(v!='' && v.length == 11){
						var reg = /^1[3|4|5|7|8][0-9]\d{4,8}$/;
						if(!reg.test(value)){
							return '联系人手机号码格式不对,请从新输入';
						}
					}else{
						return '联系人手机号码格式不对,请从新输入';
					}
				}
  			});
  			form.on('submit(setLxrInfo)',function(data){
  				var field = data.field,url = '';
  				for(var attr in field){
		  			if(attr == 'lxrName'){
		  				field[attr] = $.trim(escape(field[attr]));
		  			}
		  		}
		  		if(addEditLxrOpts == 'addLxrOpts'){
		  			if(parent.isZlAddFmLxFlag){
		  				var cusIds = parent.$('#sqrIdInp').val();
		  				url = '/customer.do?action=addLxrData&cusId='+cusIds;
		  			}else{
		  				url = '/customer.do?action=addLxrData&cusId='+cusId;
		  			}
		  		}else{//编辑联系人
		  			url = '/customer.do?action=upLxrData&lxrId='+lxrId;
		  		}
  				$.ajax({
		    		type:"post",
			        async:false,
			        dataType:"json",
			        url:url,
			        data:field,
			        success:function (json){
			        	layer.closeAll('loading');
			        	if(json["result"] == 'success'){
   			        		if(addEditLxrOpts == 'editLxrOpts'){
   			        			layer.msg('编辑联系人信息成功',{icon:1,time:1000},function(){
   			        				var index= parent.layer.getFrameIndex(window.name);
		        					parent.layer.close(index);
		        					parent.editLxrFlag = true;
   			        			});
   			        		}else{
   			        			layer.msg('添加联系人信息成功',{icon:1,time:1000},function(){
   			        				var index= parent.layer.getFrameIndex(window.name);
		        					parent.layer.close(index);
		        					if(parent.isZlAddFmLxFlag){
		        						//用于代理机构下增加专利的时添加新的联系人
		        						parent.addCustFlag = true;
		        					}
   			        			});
   			        		}
			        	}else if(json["result"] == 'noInfo'){
			        		layer.msg("暂无此信息，请重试！",{icon:5,anim:6,time:1000});
			        	}else if(json["result"] == 'error'){
			        		layer.msg("保存失败，请重试！",{icon:5,anim:6,time:1000});
			        	}else if(json["result"] == 'noAbility'){
			        		layer.msg("抱歉，您暂无权限对联系人信息进行编辑！",{icon:5,anim:6,time:2500});
			        	}
			        }
		    	});
  			});
			$(function(){
				page.init();
			});
		});
	</script>
</body> 
</html>